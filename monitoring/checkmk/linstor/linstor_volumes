#!/bin/bash
#
# Check_MK Local Check: LINSTOR Volumes
# File: /usr/lib/check_mk_agent/local/linstor_volumes
#
# Monitors LINSTOR volume definitions and states
# Uses JSON API for reliable data parsing
#
# Author: somnium78
# Version: 1.0.0
# Date: 2025-08-30
#

check_linstor_volumes() {
    if ! command -v linstor >/dev/null 2>&1; then
        echo "2 LINSTOR_Volumes - CRITICAL: linstor command not found"
        return
    fi

    volumes_json=$(linstor -m volume-definition list 2>/dev/null)

    if [ $? -ne 0 ]; then
        echo "2 LINSTOR_Volumes - CRITICAL: Failed to query LINSTOR volumes"
        return
    fi

    # Count volume definitions
    total_volumes=$(echo "$volumes_json" | grep -c '"volume_number"')

    if [ $total_volumes -eq 0 ]; then
        echo "1 LINSTOR_Volumes - WARNING: No volume definitions found"
        return
    fi

    # Count volumes by size categories (in KiB)
    small_volumes=$(echo "$volumes_json" | grep '"size_kib"' | awk -F'"size_kib": ' '{print $2}' | awk -F',' '{print $1}' | awk '$1 < 10485760 {count++} END {print count+0}')  # < 10GB
    medium_volumes=$(echo "$volumes_json" | grep '"size_kib"' | awk -F'"size_kib": ' '{print $2}' | awk -F',' '{print $1}' | awk '$1 >= 10485760 && $1 < 104857600 {count++} END {print count+0}')  # 10GB-100GB
    large_volumes=$(echo "$volumes_json" | grep '"size_kib"' | awk -F'"size_kib": ' '{print $2}' | awk -F',' '{print $1}' | awk '$1 >= 104857600 {count++} END {print count+0}')  # > 100GB

    # Calculate total storage (approximate, in GB)
    total_storage_gb=$(echo "$volumes_json" | grep '"size_kib"' | awk -F'"size_kib": ' '{print $2}' | awk -F',' '{print $1}' | awk '{sum += $1} END {print int(sum/1048576)}')

    # Check for encryption
    encrypted_volumes=$(echo "$volumes_json" | grep -c '"ENCRYPTED"')

    status=0
    state="OK"

    echo "$status LINSTOR_Volumes total=$total_volumes;small=$small_volumes;medium=$medium_volumes;large=$large_volumes;encrypted=$encrypted_volumes;total_gb=$total_storage_gb $state: $total_volumes volumes (${total_storage_gb}GB total, $encrypted_volumes encrypted)"
}

check_linstor_volumes
