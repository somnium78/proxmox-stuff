#!/bin/bash
#
# Check_MK Local Check: LINSTOR Performance
# File: /usr/lib/check_mk_agent/local/linstor_performance
#
# Monitors LINSTOR performance metrics and DRBD statistics
# Uses JSON API for reliable data parsing
#
# Author: somnium78
# Version: 1.0.0
# Date: 2025-08-30
#

check_linstor_performance() {
    if ! command -v linstor >/dev/null 2>&1; then
        echo "2 LINSTOR_Performance - CRITICAL: linstor command not found"
        return
    fi

    # Get resource statistics (if available)
    stats_json=$(linstor -m resource list-statistics 2>/dev/null)

    if [ $? -ne 0 ]; then
        # Fallback: Basic resource info
        resources_json=$(linstor -m resource list 2>/dev/null)
        if [ $? -ne 0 ]; then
            echo "2 LINSTOR_Performance - CRITICAL: Failed to query LINSTOR resources"
            return
        fi

        # Count resources in sync
        in_sync_resources=$(echo "$resources_json" | grep -c '"disk_state": "UpToDate"')
        total_resources=$(echo "$resources_json" | grep -c '"node_name"')
        sync_percentage=$((in_sync_resources * 100 / total_resources))

        # Basic performance metrics
        diskless_resources=$(echo "$resources_json" | grep -c '"disk_state": "Diskless"')

        status=0
        state="OK"

        echo "$status LINSTOR_Performance sync_percentage=$sync_percentage;in_sync=$in_sync_resources;total=$total_resources;diskless=$diskless_resources $state: ${sync_percentage}% resources in sync ($in_sync_resources/$total_resources)"
        return
    fi

    # If statistics are available, parse them
    # Note: This depends on LINSTOR version and available statistics
    total_read_ops=$(echo "$stats_json" | grep -o '"read_ops": [0-9]*' | awk -F': ' '{sum += $2} END {print sum+0}')
    total_write_ops=$(echo "$stats_json" | grep -o '"write_ops": [0-9]*' | awk -F': ' '{sum += $2} END {print sum+0}')

    status=0
    state="OK"

    echo "$status LINSTOR_Performance read_ops=$total_read_ops;write_ops=$total_write_ops $state: Performance stats (${total_read_ops} reads, ${total_write_ops} writes)"
}

check_linstor_performance
