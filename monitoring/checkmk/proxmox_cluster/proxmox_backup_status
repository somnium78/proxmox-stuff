#!/bin/bash
#
# Check_MK Local Check: Proxmox Backup Status (PBS)
# File: /usr/lib/check_mk_agent/local/proxmox_backup_status
#
# Monitors Proxmox Backup Server job status
# Author: somnium78
# Version: 1.1.0
# Date: 2025-08-30
#

check_proxmox_backup_status() {
    # Check PBS backup log directory
    backup_log_dir="/var/log/proxmox-backup/tasks"

    if [ ! -d "$backup_log_dir" ]; then
        echo "1 Proxmox_Backup_Status - WARNING: PBS backup log directory not found"
        return
    fi

    # Get recent backup tasks (last 24 hours)
    recent_backups=$(find "$backup_log_dir" -name "*backup*" -mtime -1 2>/dev/null)

    if [ -z "$recent_backups" ]; then
        echo "1 Proxmox_Backup_Status recent_backups=0;successful=0;failed=0 WARNING: No recent backup tasks found"
        return
    fi

    # Count backup results
    total_backups=0
    successful_backups=0
    failed_backups=0

    for backup_file in $recent_backups; do
        if [ -f "$backup_file" ]; then
            total_backups=$((total_backups + 1))

            # Check PBS backup status patterns
            if grep -q "backup finished successfully\|TASK OK" "$backup_file" 2>/dev/null; then
                successful_backups=$((successful_backups + 1))
            elif grep -q "backup failed\|TASK ERROR\|TASK WARNINGS" "$backup_file" 2>/dev/null; then
                failed_backups=$((failed_backups + 1))
            fi
        fi
    done

    # Determine status
    if [ $failed_backups -gt 0 ]; then
        status=2
        state="CRITICAL"
    elif [ $total_backups -eq 0 ]; then
        status=1
        state="WARNING"
    else
        status=0
        state="OK"
    fi

    echo "$status Proxmox_Backup_Status recent_backups=$total_backups;successful=$successful_backups;failed=$failed_backups $state: $total_backups recent PBS backups ($successful_backups successful, $failed_backups failed)"
}

check_proxmox_backup_status
