#!/bin/bash
#
# Check_MK Local Check: Proxmox Cluster Status
# File: /usr/lib/check_mk_agent/local/proxmox_cluster
#
# Monitors Proxmox cluster health and node status
# Author: somnium78
# Version: 1.0.0
# Date: 2025-08-30
#

check_proxmox_cluster() {
    if ! command -v pvecm >/dev/null 2>&1; then
        echo "2 Proxmox_Cluster - CRITICAL: pvecm command not found"
        return
    fi

    # Check if this node is part of a cluster
    cluster_status=$(pvecm status 2>/dev/null)

    if [ $? -ne 0 ]; then
        echo "1 Proxmox_Cluster - WARNING: Not part of a cluster or cluster not accessible"
        return
    fi

    # Parse cluster information
    cluster_name=$(echo "$cluster_status" | grep "Cluster name:" | awk '{print $3}')
    config_version=$(echo "$cluster_status" | grep "Config Version:" | awk '{print $3}')

    # Count nodes
    total_nodes=$(echo "$cluster_status" | grep -c "^[0-9]")
    online_nodes=$(echo "$cluster_status" | grep -c "M")

    # Check quorum
    quorum_status=$(echo "$cluster_status" | grep "Quorate:" | awk '{print $2}')
    expected_votes=$(echo "$cluster_status" | grep "Expected votes:" | awk '{print $3}')
    total_votes=$(echo "$cluster_status" | grep "Total votes:" | awk '{print $3}')

    # Check if quorate
    if [ "$quorum_status" = "Yes" ]; then
        quorate=1
    else
        quorate=0
    fi

    # Determine status
    if [ $quorate -eq 0 ]; then
        status=2
        state="CRITICAL"
    elif [ $online_nodes -lt $total_nodes ]; then
        status=1
        state="WARNING"
    else
        status=0
        state="OK"
    fi

    echo "$status Proxmox_Cluster total_nodes=$total_nodes;online_nodes=$online_nodes;quorate=$quorate;expected_votes=$expected_votes;total_votes=$total_votes $state: Cluster '$cluster_name' ($online_nodes/$total_nodes nodes online, quorate: $quorum_status)"
}

check_proxmox_cluster
