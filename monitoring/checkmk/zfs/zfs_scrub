#!/bin/bash
#
# Check_MK Local Check: ZFS Scrub Status
# File: /usr/lib/check_mk_agent/local/zfs_scrub
#
# Monitors ZFS scrub operations and schedules
# Author: somnium78
# Version: 1.0.0
# Date: 2025-08-30
#

check_zfs_scrub() {
    if ! command -v zpool >/dev/null 2>&1; then
        echo "2 ZFS_Scrub - CRITICAL: zpool command not found"
        return
    fi

    pool_status=$(zpool status 2>/dev/null)

    if [ $? -ne 0 ]; then
        echo "2 ZFS_Scrub - CRITICAL: Failed to query ZFS pools"
        return
    fi

    # Count scrub states
    scrub_in_progress=$(echo "$pool_status" | grep -c "scrub in progress")
    scrub_completed=$(echo "$pool_status" | grep -c "scrub repaired")
    scrub_cancelled=$(echo "$pool_status" | grep -c "scrub canceled")
    no_scrub=$(echo "$pool_status" | grep -c "none requested")

    # Check for old scrubs (>30 days)
    current_time=$(date +%s)
    old_scrubs=0

    # Extract scrub completion dates and check age
    while IFS= read -r line; do
        if echo "$line" | grep -q "scrub repaired.*on"; then
            scrub_date=$(echo "$line" | sed -n 's/.*on \([A-Za-z]* [A-Za-z]* [0-9]* [0-9]*:[0-9]*:[0-9]* [0-9]*\).*/\1/p')
            if [ -n "$scrub_date" ]; then
                scrub_timestamp=$(date -d "$scrub_date" +%s 2>/dev/null || echo 0)
                if [ $scrub_timestamp -gt 0 ]; then
                    days_ago=$(( (current_time - scrub_timestamp) / 86400 ))
                    if [ $days_ago -gt 30 ]; then
                        old_scrubs=$((old_scrubs + 1))
                    fi
                fi
            fi
        fi
    done <<< "$pool_status"

    # Determine status
    if [ $old_scrubs -gt 0 ]; then
        status=1
        state="WARNING"
    elif [ $scrub_cancelled -gt 0 ]; then
        status=1
        state="WARNING"
    else
        status=0
        state="OK"
    fi

    echo "$status ZFS_Scrub active=$scrub_in_progress;completed=$scrub_completed;cancelled=$scrub_cancelled;old_scrubs=$old_scrubs $state: Scrub status (${scrub_in_progress} active, ${old_scrubs} >30 days old)"
}

check_zfs_scrub
